#!/usr/bin/env python3
"""
Pipeline Dependency Checker

Checks if all required dependencies for the ChatMind pipeline are installed.
"""

import importlib
import sys
from pathlib import Path

def check_dependency(module_name: str, package_name: str = None) -> bool:
    """Check if a dependency is available."""
    try:
        importlib.import_module(module_name)
        return True
    except ImportError:
        return False

def main():
    """Check all pipeline dependencies."""
    print("ğŸ” Checking ChatMind pipeline dependencies...")
    print("=" * 50)
    
    # Core dependencies
    core_deps = [
        ("pandas", "pandas"),
        ("numpy", "numpy"),
        ("jsonlines", "jsonlines"),
        ("click", "click"),
        ("tqdm", "tqdm"),
    ]
    
    # ML/AI dependencies
    ml_deps = [
        ("sentence_transformers", "sentence-transformers"),
        ("sklearn", "scikit-learn"),
        ("hdbscan", "hdbscan"),
        ("umap", "umap-learn"),
    ]
    
    # Optional dependencies
    optional_deps = [
        ("openai", "openai"),
        ("requests", "requests"),
    ]
    
    all_good = True
    
    print("ğŸ“¦ Core Dependencies:")
    for module, package in core_deps:
        if check_dependency(module):
            print(f"  âœ… {package}")
        else:
            print(f"  âŒ {package} - MISSING")
            all_good = False
    
    print("\nğŸ¤– ML/AI Dependencies:")
    for module, package in ml_deps:
        if check_dependency(module):
            print(f"  âœ… {package}")
        else:
            print(f"  âŒ {package} - MISSING")
            all_good = False
    
    print("\nğŸ”§ Optional Dependencies:")
    for module, package in optional_deps:
        if check_dependency(module):
            print(f"  âœ… {package}")
        else:
            print(f"  âš ï¸  {package} - Optional (for cloud API)")
    
    print("\n" + "=" * 50)
    
    if all_good:
        print("ğŸ‰ All required dependencies are installed!")
        print("âœ… You can run the pipeline with: python run_pipeline.py")
    else:
        print("âŒ Some dependencies are missing.")
        print("ğŸ’¡ Install missing dependencies with:")
        print("   pip install -r chatmind/pipeline/requirements.txt")
    
    # Check for external tools
    print("\nğŸ”§ External Tools:")
    
    # Check Ollama
    try:
        import subprocess
        result = subprocess.run(["ollama", "--version"], capture_output=True, text=True)
        if result.returncode == 0:
            print("  âœ… Ollama (for local models)")
        else:
            print("  âŒ Ollama - not found")
    except FileNotFoundError:
        print("  âŒ Ollama - not found")
    
    # Check Neo4j
    try:
        import subprocess
        result = subprocess.run(["neo4j", "--version"], capture_output=True, text=True)
        if result.returncode == 0:
            print("  âœ… Neo4j (for graph database)")
        else:
            print("  âš ï¸  Neo4j - not found (optional for pipeline)")
    except FileNotFoundError:
        print("  âš ï¸  Neo4j - not found (optional for pipeline)")
    
    return 0 if all_good else 1

if __name__ == "__main__":
    exit(main()) 